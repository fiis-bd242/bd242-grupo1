# 8.1. Sentencias SQL por módulo / prototipo

## Módulo de Gestión de Promociones

### Código Requerimiento: P-001

Código Interfaz: PI-001

Imagen interfaz:

 <img src="./image (5).png" alt="Creación de Promociones" style="width: 75%; height: auto;" />

Sentencias SQL:

Eventos:

1.- Cargar la pagina: Se observan las promociones existentes

```sql 
select 
	a.fecha_inicio,
	a.cod_promocion,
	a.dscto,
	a.precio_final,
	a.fecha_fin - a.fecha_inicio AS vigencia_dias,
	a.estado_promo as estado,
	b.nombre_seller  as seller
from promocion a
inner join seller b on a.cod_promocion=b.cod_seller
```

2.- Búsqueda por codigo de promocion:
```sql
select 
	a.fecha_inicio,
	a.cod_promocion,
	a.dscto,
	a.precio_final,
	a.fecha_fin - a.fecha_inicio AS vigencia_dias,
	a.estado_promo as estado,
	b.nombre_seller  as seller
from promocion a
inner join seller b on a.cod_promocion=b.cod_seller
WHERE cod_promocion = <1>
```

3.- Búsqueda por vigencia:
```sql
select 
	a.fecha_inicio,
	a.cod_promocion,
	a.dscto,
	a.precio_final,
	a.fecha_fin - a.fecha_inicio AS vigencia_dias,
	a.estado_promo as estado,
	b.nombre_seller  as seller
from promocion a
inner join seller b on a.cod_promocion=b.cod_seller
WHERE vigencia = <2>;
```

4.- Búsqueda por seller:
```sql
select 
	a.fecha_inicio,
	a.cod_promocion,
	a.dscto,
	a.precio_final,
	a.fecha_fin - a.fecha_inicio AS vigencia_dias,
	a.estado_promo as estado,
	b.nombre_seller  as seller
from promocion a
inner join seller b on a.cod_promocion=b.cod_seller
WHERE b.nombre_seller = <3>;
```

|Donde:|
|--------------------------------------------|
|<1> es el ID de la promoción. |
|<2> es la cantidad de días de la vigencia. |
|<3> es el nombre del seller seleccionada. |


### Código Requerimiento: P-002

Código Interfaz: PI-002

Imagen interfaz:

<img src="./image (6).png" alt="Creación de Promociones" style="width: 75%; height: auto;" />

Sentencias SQL:

1.- Crear promoción:

```sql
Insert into Promocion (cod_promocion, fecha_inicio, fecha_fin, dscto, precio_final, estado_promo, dscrip_promo, ID_empleado)
Values (41,20-11-2024,25-12-2024,30,45,FALSE,'Promocion valido hasta antes de navidad', 40);
```

### Código Requerimiento: P-003

Código Interfaz: PI-003

Imagen interfaz:

<img src="./image (7).png" alt="Creación de Promociones" style="width: 75%; height: auto;" />

Sentencias SQL:

1.- Cargar la pagina
```sql
select * from producto
```
Código Interfaz: PI-004

Imagen interfaz:

<img src="./image (8).png" alt="Creación de Promociones" style="width: 75%; height: auto;" />

2.-Crear producto:
```sql
INSERT INTO Producto (cod_producto, nombre_producto, empresa, cod_tipo_producto) 
VALUES 
    (41, 'Hamburguesa Clásica', 'McDonalds', 1);
```

### Código Requemiento: P-004

Código Interfaz: PI-005

Imagen interfaz:

<img src="./image (9).png" alt="Creación de Promociones" style="width: 75%; height: auto;" />

Sentencias SQL:
1.- Editar promocion:

```sql
UPDATE promocion
SET precio_final=43
Where cod_promocion=1
```

### Código Requemiento: P-005

Código Interfaz: PI-006

Imagen interfaz:

<img src="./image (10).png" alt="Creación de Promociones" style="width: 75%; height: auto;" />

Sentencias SQL:
1.- Cargar pagina
```sql
select * from producto
```

Código Interfaz: PI-007

Imagen interfaz:

<img src="./image (11).png" alt="Creación de Promociones" style="width: 75%; height: auto;" />

2.- Editar producto:
```sql
UPDATE producto
SET nombre_producto='Macdonalds'
Where cod_producto=1
```

### Código Requemiento: P-006

Código Interfaz: PI-008

Imagen interfaz:

<img src="./image (13).png" alt="Creación de Promociones" style="width: 75%; height: auto;" />

Sentencias SQL:
1.- Promociones activas:
```sql
select 
	a.fecha_inicio,
	a.fecha_fin,
	a.cod_promocion,
	a.dscto,
	a.precio_final,
	a.fecha_fin - a.fecha_inicio AS vigencia_dias,
	a.estado_promo as estado,
	b.nombre_seller  as seller,
	a.dscrip_promo
from promocion a
inner join seller b on a.cod_promocion=b.cod_seller
where a.estado_promo=TRUE;
```

2.- Búsqueda por codigo de promocion:
```sql
select 
	a.fecha_inicio,
	a.fecha_fin,
	a.cod_promocion,
	a.dscto,
	a.precio_final,
	a.fecha_fin - a.fecha_inicio AS vigencia_dias,
	a.estado_promo as estado,
	b.nombre_seller  as seller,
	a.dscrip_promo
from promocion a
inner join seller b on a.cod_promocion=b.cod_seller
WHERE cod_promocion = <1>
```

3.- Búsqueda por vigencia:
```sql
select 
	a.fecha_inicio,
	a.fecha_fin,
	a.cod_promocion,
	a.dscto,
	a.precio_final,
	a.fecha_fin - a.fecha_inicio AS vigencia_dias,
	a.estado_promo as estado,
	b.nombre_seller  as seller,
	a.dscrip_promo
from promocion a
inner join seller b on a.cod_promocion=b.cod_seller
WHERE vigencia = <2>;
```

4.- Búsqueda por seller:
```sql
select 
	a.fecha_inicio,
	a.fecha_fin,
	a.cod_promocion,
	a.dscto,
	a.precio_final,
	a.fecha_fin - a.fecha_inicio AS vigencia_dias,
	a.estado_promo as estado,
	b.nombre_seller  as seller,
	a.dscrip_promo
from promocion a
inner join seller b on a.cod_promocion=b.cod_seller
WHERE b.nombre_seller = <3>;
```

|Donde:|
|--------------------------------------------|
|<1> es el ID de la promoción. |
|<2> es la cantidad de días de la vigencia. |
|<3> es el nombre del seller seleccionada. |


### Código de Requerimiento: P-007
Filtros avanzados de búsqueda de promociones.

Código Interfaz: PI-007

Imagen Interfaz:

Sentencias SQL:
1.- Buscar promociones por rango de descuento:
```sql
SELECT * 
FROM promocion
WHERE dscto BETWEEN <descuento_min> AND <descuento_max>;
```
2.- Buscar promociones por rango de precio final:
```sql
SELECT * 
FROM promocion
WHERE precio_final BETWEEN <precio_min> AND <precio_max>;
```
3.- Promociones próximas a expirar:
```sql
SELECT 
    cod_promocion,
    dscto,
    precio_final,
    fecha_fin,
    estado_promo
FROM promocion
WHERE fecha_fin BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '14 days';
```

## Modulo de Campañas Publicitarias

#### Código Requerimiento: CP-001<br> 

#### Código Interfaz: ICP-001<br>

Imagen Interfaz.  
![image](https://github.com/user-attachments/assets/6b3694d9-56fd-4a9a-8ab7-c113846eb489)

#### Código Interfaz: ICP-002<br>
![image](https://github.com/user-attachments/assets/9dcbc66d-3294-4eed-9e43-09126042bb37)

#### Código Interfaz:  ICP-003 <br>
![image](https://github.com/user-attachments/assets/eb798fdf-d0ce-47e2-a1b4-1a29e0fad97c)

#### Boton: Ver campañas de ICP-001 lo redirecciona a la interfaz ICP-002 <br>

### Sentencias SQL
```sql
SELECT 
    c.Nombre_campana,                   -- Nombre de la campaña
    c.Resultado,          -- Descripción de la campaña
    c.fecha_publicacion,                 -- Fecha de publicación
    c.presupuesto, 
    r.url_recurso AS Imagen              -- URL de la imagen (asumiendo que es un recurso de imagen)
FROM 
    Campana_Publicitaria c
JOIN 
    Prototipo p ON c.cod_prototipo = p.cod_prototipo
JOIN 
    recursos r ON p.cod_prototipo = r.cod_prototipo

WHERE 
    r.id_tipo_recurso = (SELECT id_tipo_recurso 
                         FROM Tipo_recurso 
                         WHERE nombre_tipo = 'Foto');  -- Filtrar por tipo de recurso "Imagen"

```
#### Buscar: Cuando rellena el cuadro buscar y presiona el boton le aparece el listado de Campañas con ese nombre

### Sentencias SQL
```sql
CREATE INDEX idx_nombre_campana_tsv_gin 
ON Campana_Publicitaria USING GIN(to_tsvector('spanish', Nombre_campana));

--Busqueda por nombre
SELECT 
    c.Nombre_campana,                   -- Nombre de la campaña
    c.Resultado,          -- Descripción de la campaña
    c.fecha_publicacion,                 -- Fecha de publicación
    c.presupuesto, 
    r.url_recurso AS Imagen              -- URL de la imagen (asumiendo que es un recurso de imagen)
FROM 
    Campana_Publicitaria c
JOIN 
    Prototipo p ON c.cod_prototipo = p.cod_prototipo
JOIN 
    recursos r ON p.cod_prototipo = r.cod_prototipo

WHERE 
    r.id_tipo_recurso = (SELECT id_tipo_recurso 
                         FROM Tipo_recurso 
                         WHERE nombre_tipo = 'Foto')
AND to_tsvector('spanish', c.Nombre_campana) @@ plainto_tsquery('spanish', 'Verano'); 
```
#### Boton Ordenar por de la interfaz ICP-002 lo redirecciona a la interfaz ICP-003 <br>

### Sentencias SQL
```sql
--Ordenar por presupuesto de mayor a menor
SELECT 
    c.Nombre_campana,                   -- Nombre de la campaña
    c.Resultado AS Descripcion,          -- Descripción de la campaña
    c.fecha_publicacion,                 -- Fecha de publicación
    c.presupuesto,
    r.url_recurso AS Imagen              -- URL de la imagen (asumiendo que es un recurso de imagen)

FROM 
    Campana_Publicitaria c
JOIN 
    Prototipo p ON c.cod_prototipo = p.cod_prototipo
JOIN 
    recursos r ON p.cod_prototipo = r.cod_prototipo
WHERE 
    r.id_tipo_recurso = (SELECT id_tipo_recurso 
                         FROM Tipo_recurso 
                         WHERE nombre_tipo = 'Foto')
ORDER BY 
    c.Presupuesto desc ;   -- Ordenar por presupuesto de mayor a menor
```
```sql
--Ordenar por fecha de mayor a menor
SELECT 
    c.Nombre_campana,                  
    c.Resultado,          
    c.fecha_publicacion,                
    c.presupuesto,
    r.url_recurso AS Imagen
FROM 
    Campana_Publicitaria c
JOIN 
    Prototipo p ON c.cod_prototipo = p.cod_prototipo
JOIN 
    recursos r ON p.cod_prototipo = r.cod_prototipo
WHERE 
    r.id_tipo_recurso = (SELECT id_tipo_recurso 
                         FROM Tipo_recurso 
                         WHERE nombre_tipo = 'Foto')
ORDER BY 
    c.fecha_publicacion DESC;  
```
```sql
-- ordenar por nombre
SELECT 
    c.Nombre_campana,                  
    c.Resultado,          
    c.fecha_publicacion,                 
    c.presupuesto,
    r.url_recurso AS Imagen             

FROM 
    Campana_Publicitaria c
JOIN 
    Prototipo p ON c.cod_prototipo = p.cod_prototipo
JOIN 
    recursos r ON p.cod_prototipo = r.cod_prototipo
WHERE 
    r.id_tipo_recurso = (SELECT id_tipo_recurso 
                         FROM Tipo_recurso 
                         WHERE nombre_tipo = 'Foto')
ORDER BY 
    c.nombre_campana DESC;

```
#### Código Requerimiento: CP-002<br> 

#### Código Interfaz: ICP-004<br>

![image](https://github.com/user-attachments/assets/e7da1c65-5475-41d1-a586-9533f413850b)

#### Código Interfaz: ICP-005<br> 
![image](https://github.com/user-attachments/assets/8d1289c0-60fb-4572-bb04-a18ffa76797a)

### Sentencias SQL
#### Eentos
#### Boton Ver Mas
Despues presionar el boton Ver Mas que aparece en la interfaz ICP-003 se redirecciona a la interfaz ICP-004 donde se veran los detalles de la campaña
```sql
SELECT       
    cp.nombre_campana,                                     -- Nombre de la campaña
    e.Nombre || ' ' || e.Apellido AS Autor,               -- Autor del prototipo (Nombre completo del empleado)
    ep.estado_prot AS Estado,                              -- Estado del prototipo
    STRING_AGG(DISTINCT c.nombre_canal, ', ') AS Canal_difusion, -- Concatenación de los nombres de canales de difusión
    a.id_audiencia AS Codigo_audiencia,                    -- Código de la audiencia
    a.Edad_rango,                                          -- Rango de edad de la audiencia
    a.Genero,                                              -- Género de la audiencia
    a.Ubicacion,                                           -- Ubicación de la audiencia
    p.Prop_presupuesto AS Presupuesto,                     -- Presupuesto del prototipo
    STRING_AGG(DISTINCT o.Descripcion, ', ') AS Objetivos, -- Concatenación de los objetivos
    r.url_recurso AS Foto                                  -- URL de la imagen asociada al prototipo
FROM 
    Campana_Publicitaria cp 
JOIN 
    Prototipo p ON cp.cod_prototipo = p.cod_prototipo     -- Asegúrate de que haya una relación entre las tablas
JOIN 
    Empleado e ON p.ID_empleado = e.ID_empleado
JOIN 
    Audiencia a ON p.Prop_audiencia = a.id_audiencia
LEFT JOIN 
    Estado_prototipo ep ON p.cod_est_prot = ep.cod_est_prot
LEFT JOIN 
    prototipoxcanal pc ON p.cod_prototipo = pc.cod_prototipo
LEFT JOIN 
    Canal c ON pc.cod_canal = c.cod_canal
LEFT JOIN 
    Objetivos o ON p.cod_prototipo = o.cod_prototipo
LEFT JOIN 
    Recursos r ON p.cod_prototipo = r.cod_prototipo 
               AND r.id_tipo_recurso = (SELECT id_tipo_recurso 
                                        FROM Tipo_recurso 
                                        WHERE nombre_tipo = 'Foto')
WHERE 
    cp.cod_campana = 1                                  -- Reemplaza '4' con el ID específico del prototipo que deseas ver
GROUP BY 
    cp.nombre_campana, e.Nombre, e.Apellido, ep.estado_prot, 
    a.id_audiencia, a.Edad_rango, a.Genero, a.Ubicacion, p.Prop_presupuesto, r.url_recurso;

```
#### Boton Generar reporte
En este caso se genera el reporte para cada canal en el que se trabajo la campaña publicitaria, este boton redirige al usuario de la interfaz ICP-004 a la interfaz ICP-005

```sql
SELECT 
    c.nombre_canal,
    pc.impresiones,
    pc.clics,
    pc.conversiones,
    (pc.clics::numeric / NULLIF(pc.impresiones, 0)) * 100 AS CTR,              -- Tasa de clics
    (pc.conversiones::numeric / NULLIF(pc.clics, 0)) * 100 AS ConversionRate,   -- Tasa de conversión
    (cp.Presupuesto / NULLIF(pc.conversiones, 0)) AS CPC                       -- Costo por conversión
FROM 
    Campana_Publicitaria cp
JOIN 
    prototipoxcanal pc ON cp.cod_prototipo = pc.cod_prototipo
JOIN 
    Canal c ON pc.cod_canal = c.cod_canal
WHERE 
    cp.cod_campana  = 1;	
```
#### Código Requerimiento: CP-003<br> 

#### Código Interfaz: ICP-006<br>

![image](https://github.com/user-attachments/assets/ffd57ca0-0866-4498-aa52-329a549f290f)

#### Código Interfaz: ICP-007<br>

![image](https://github.com/user-attachments/assets/43e9a749-2fcb-41d1-a4e4-8787e357640e)

### Sentencias SQL
#### Eventos
#### Boton Mis propuestas
Este boton redirige al usuario de la interfaz ICP-002 a la interfaz ICP-006, donde se ven las propuestas del usuario
```sql
SELECT 
    e.Nombre,                                  -- Nombre del empleado
    e.Apellido,                                -- Apellido del empleado
    p.cod_prototipo,                           -- Código del prototipo
    p.Fecha_creacion,                          -- Fecha de creación del prototipo
    ep.estado_prot AS Estado,                  -- Estado del prototipo
    r.url_recurso  as imagen                  -- URL de la imagen del prototipo (puede ser NULL)
FROM 
    Empleado e  
JOIN 
    Prototipo p ON e.ID_empleado = p.ID_empleado
LEFT JOIN 
    Estado_prototipo ep ON p.cod_est_prot = ep.cod_est_prot
LEFT JOIN 
    Recursos r ON p.cod_prototipo = r.cod_prototipo 
               AND r.id_tipo_recurso = (SELECT id_tipo_recurso 
                                        FROM Tipo_recurso 
                                        WHERE nombre_tipo = 'Documento') -- Filtrar solo fotos
WHERE 
    e.ID_empleado = 5                         -- Filtro para el empleado con ID 5
ORDER BY 
    p.cod_prototipo;
```
#### Boton Ver Mas
Este boton redirige al usuario de la interfaz ICP-006 a la interfaz ICP-007, donde se ven los detalles de una propuesta
```sql
SELECT   	
	p.nombre_prot,
    e.Nombre || ' ' || e.Apellido AS Autor,                  -- Autor del prototipo (Nombre completo del empleado)
    ep.estado_prot AS Estado,                                -- Estado del prototipo
    STRING_AGG(DISTINCT c.nombre_canal, ', ') AS Canal_difusion, -- Concatenación de los nombres de canales de difusión
    a.id_audiencia AS Codigo_audiencia,                      -- Código de la audiencia
    a.Edad_rango,                                            -- Rango de edad de la audiencia
    a.Genero,                                                -- Género de la audiencia
    a.Ubicacion,                                             -- Ubicación de la audiencia
    p.Prop_presupuesto AS Presupuesto,                       -- Presupuesto del prototipo
    STRING_AGG(DISTINCT o.Descripcion, ', ') AS Objetivos,   -- Concatenación de los objetivos
    r.url_recurso AS Foto                                    -- URL de la imagen asociada al prototipo
FROM 
    Prototipo p
JOIN 
    Empleado e ON p.ID_empleado = e.ID_empleado
JOIN 
    Audiencia a ON p.Prop_audiencia = a.id_audiencia
LEFT JOIN 
    Estado_prototipo ep ON p.cod_est_prot = ep.cod_est_prot
LEFT JOIN 
    prototipoxcanal pc ON p.cod_prototipo = pc.cod_prototipo
LEFT JOIN 
    Canal c ON pc.cod_canal = c.cod_canal
LEFT JOIN 
    Objetivos o ON p.cod_prototipo = o.cod_prototipo
LEFT JOIN 
    Recursos r ON p.cod_prototipo = r.cod_prototipo 
               AND r.id_tipo_recurso = (SELECT id_tipo_recurso 
                                        FROM Tipo_recurso 
                                        WHERE nombre_tipo = 'Foto')
WHERE 
    p.cod_prototipo = 4                                      -- Reemplaza '4' con el ID específico del prototipo que desea ver
GROUP BY 
    p.cod_prototipo, e.Nombre, e.Apellido, ep.estado_prot, 
    a.id_audiencia, a.Edad_rango, a.Genero, a.Ubicacion, p.Prop_presupuesto, r.url_recurso;
```
#### Código Requerimiento: CP-004<br> 

#### Código Interfaz: ICP-008<br>

![image](https://github.com/user-attachments/assets/66e2d5c1-8b3e-4368-8bc4-a1f88a97694e)

#### Código Interfaz: ICP-009<br>

![image](https://github.com/user-attachments/assets/825458b6-6b17-4f2e-b890-9ecee6d699e3)

### Sentencias SQL
#### Eventos

#### Boton Editar archivos 
Este boton lo redirije de la interfaz ICP-007 a la ICP-008 donde el usuario puede agregar sus archivos
### Boton Subir Archivos
Este boton guarda en la base de datos los archivos seleccionados
```sql
UPDATE Prototipo
SET 
    nombre_prot = 'Nuevo Nombre del Prototipo',        -- Cambia esto al nuevo nombre
    descripcion = 'Nueva descripción del prototipo',   -- Cambia esto a la nueva descripción
    prop_presupuesto = 50000                           -- Cambia esto al nuevo presupuesto deseado
WHERE 
    cod_prototipo = 4;                                 -- Reemplaza '4' con el ID del prototipo que deseas actualizar
```
#### Boton Regresar
Con este boton regresa de la interfaz ICP-008 a la ICP-007 

#### Boton Editar Datos
Manda al usuario de la interfaz ICP-007 a la ICP-009
#### Boton Guardar
Este boton de la interfaz ICP-009 sube a la base de datos los cambios hechospor el usuario
```sql
UPDATE Prototipo
SET 
    nombre_prot = 'Nuevo Nombre del Prototipo',        -- Cambia esto al nuevo nombre
    descripcion = 'Nueva descripción del prototipo',   -- Cambia esto a la nueva descripción
    prop_presupuesto = 50000                           -- Cambia esto al nuevo presupuesto deseado
WHERE 
    cod_prototipo = 4;                                 -- Reemplaza '4' con el ID del prototipo que deseas actualizar
```

#### Código Requerimiento: CP-005<br> 

#### Código Interfaz: ICP-010<br>

Imagen Interfaz.      
![image](https://github.com/user-attachments/assets/c25951a2-6435-4df9-abff-2e93cf4e6bc3)


#### Código Interfaz: ICP-011<br>

Imagen Interfaz.
![image](https://github.com/user-attachments/assets/7766eb5a-605c-49b1-aa75-5d1aa012158b)


#### Código Interfaz: ICP-012<br>

Imagen Interfaz.
![image](https://github.com/user-attachments/assets/1187ec0a-4591-412f-98d0-6970c7958df0)


### Sentencias SQL
#### Eventos
#### Boton Crear Publicidad
En la interfaz ICP-001 se encuentra el boton de Crear Publicidad este boton al presionarlo redirige al usuario a la interfaz ICP-010 donde va a colocar los distintos parametros que se le piden
#### Boton Siguiente
El usuario pasara de la interfaz ICP-010 a la interfaz ICP-011 donde subira los archivos correspondientes teniendo en cuenta que si o si debe subir el archivo de analisis de mercado
#### Boton Guardar
El usuario al presionar el boton guardar, guardara en la base de datos todos los datos puestos en las anteriores interfaces y lo mandara la interfaz ICP-006
```sql
--1er Trigger para la Seleccion automatica de un espacio especifico para los archivos que suba el usuario creador de prototipo
CREATE OR REPLACE FUNCTION insert_null_resources()
RETURNS TRIGGER AS $$
BEGIN
    -- Insertar recursos con valores NULL para el nuevo prototipo
    INSERT INTO Recursos (nombre_recurso, url_recurso, id_tipo_recurso, cod_prototipo)
    VALUES 
        (NULL, NULL, (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Foto'), NEW.cod_prototipo),
        (NULL, NULL, (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Video'), NEW.cod_prototipo),
        (NULL, NULL, (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Guion'), NEW.cod_prototipo),
        (NULL, NULL, (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Documento'), NEW.cod_prototipo);

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

--Crear el trigger
CREATE TRIGGER after_insert_prototipo
AFTER INSERT ON Prototipo
FOR EACH ROW
EXECUTE FUNCTION insert_null_resources();

--2do Trigger para la creacion automatica del id_audiencia 
--Primera funcion es para tener las iniciales de la ubicacion
CREATE OR REPLACE FUNCTION generate_initials(location VARCHAR)
RETURNS VARCHAR AS $$
DECLARE
    initials VARCHAR := '';
    word VARCHAR;
BEGIN
    -- Dividir la ubicación en palabras y construir las siglas
    FOR word IN SELECT unnest(string_to_array(location, ' ')) LOOP
        initials := initials || LEFT(word, 1); -- Agregar la primera letra de cada palabra
    END LOOP;

    RETURN initials;
END;
$$ LANGUAGE plpgsql;

--Segunda funcion para la creacion automatica de los id_audiencia utilizando la funcion anterior
CREATE OR REPLACE FUNCTION generate_id_audiencia()
RETURNS TRIGGER AS $$
BEGIN
    NEW.id_audiencia := CONCAT(
        SUBSTRING(NEW.Edad_rango FROM 1 FOR 2), -- Min Edad
        SUBSTRING(NEW.Edad_rango FROM 4 FOR 2), -- Max Edad
        NEW.Genero,
        generate_initials(NEW.Ubicacion) -- Usar la función para obtener las siglas
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_generate_id_audiencia ON Audiencia;

CREATE TRIGGER trg_generate_id_audiencia
BEFORE INSERT ON Audiencia
FOR EACH ROW
EXECUTE FUNCTION generate_id_audiencia();
```

```sql
--Ejemplo insercion de datos
INSERT INTO Audiencia (Edad_rango, Genero, Ubicacion)
VALUES 
('25-35','F','San Juan de Lurigancho');
INSERT INTO Prototipo (nombre_prot, Descripcion, Prop_presupuesto, Fecha_creacion, Prop_audiencia, ID_empleado)
VALUES 
('Estrategia de Expansión de Mercado','Prototipo para evaluar la aceptación de un nuevo servicio en mercados jóvenes urbanos',7500.00,'2024-10-25 10:45:00','2535FL', 5);
INSERT INTO Objetivos (Descripcion, cod_prototipo)
VALUES
('Aumentar la visibilidad en el segmento de mujeres jóvenes en Lima', 5),
('Incrementar el número de clientes potenciales en un 15%', 5);  
INSERT INTO prototipoxcanal (cod_prototipo, cod_canal)
VALUES
(5, 1);
```

```sql
UPDATE Recursos
SET url_recurso = CASE 
    WHEN id_tipo_recurso = (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Foto') THEN 'http://example.com/foto'
    ELSE url_recurso -- Mantiene el valor actual si no es ninguno de los tipos mencionados
END
WHERE cod_prototipo = 5;

```

#### Código Requerimiento: CP-006<br> 

#### Código Interfaz: ICP-013<br>
![image](https://github.com/user-attachments/assets/a96396e8-341c-422e-93c1-ac4862c0245d)


#### Código Interfaz: ICP-014<br>
![image](https://github.com/user-attachments/assets/7e39767d-b573-4a7a-9c4b-d7280b143108)

### Sentencias SQL
#### Eventos
### Boton Pre-test
En la interfaz ICP-007 se encuentra el boton Pre-test al presionar este boton la audiencia colocada en las especifiaciones del prototipo se manda a la base de datos de pretest, pero esta vista solo la puede ver un miembro del area comercial en la interfaz ICP-013

### Boton Audiencia
En la interfaz ICP-013 esta el boton audiencia el cual conduce al usuario a la interfaz ICP-014

### Boton Subir
En la interfaz ICP-014 se puede crear una nueva audiencia colocando los parametros correspondientes, pero si existe una audiencia con esas especificaciones mandara un mensaje diciendo que ya existe.

### Boton regresar
En la interfaz ICP-014 el boton regresar mandara al usuario a la interfaz ICP-13 

### Boton Mandar Prototipo
En la interfaz ICP-013 el boton mandar prototipo, mandara los datos registrados a un tercero de mayor rango y mayor conocimiento para decidir entre las dos propuestas de audiencia, cuando se cambie el parametro de resultado la audiencia del prototipo asociado al pre-test se cambiara automaticamente
```sql
INSERT INTO Pre_test (AudienciaA, Fecha_inicio, cod_prototipo, id_empleado)
VALUES
    ('2535FL', '2024-10-10 09:00:00', 5, 9);
```
```sql
--audiencia nueva
INSERT INTO Audiencia (id_audiencia, Edad_rango, Genero, Ubicacion)
VALUES
    ('4655MA', '46-55', 'M', 'Arequipa');
```

```sql
-- subida de la audiencia B
UPDATE Pre_test
SET AudienciaB = '4655MA'
WHERE id_pretest = 5;
```
```sql
UPDATE Pre_test
SET 
    Resultado = '4655MA',   
    Fecha_fin = '2024-11-15 17:00:00'     
WHERE 
    id_pretest = 5;  
```
```sql
UPDATE Prototipo
SET 
    Prop_audiencia = pt.Resultado                   -- Cambia `Prop_audiencia` a la audiencia indicada en `Resultado`
FROM 
    Pre_test pt
WHERE 
    Prototipo.cod_prototipo = pt.cod_prototipo      -- Relaciona `Prototipo` con `Pre_test` mediante `cod_prototipo`
    AND pt.id_pretest = 5; 
```

### Código Requerimiento: CP-007<br>

#### Código Interfaz: ICP-007<br>

![image](https://github.com/user-attachments/assets/43e9a749-2fcb-41d1-a4e4-8787e357640e)

### Sentencias SQL
#### Eventos
#### Boton Mandar Propuesta
Este boton que se encuentra en la interfaz ICP-007 va a cambiar el estado del prototipo a pendiente de manera automatica 

```sql
UPDATE Prototipo
SET 
    cod_est_prot = (SELECT cod_est_prot 
                    FROM Estado_prototipo 
                    WHERE estado_prot = 'Pendiente'),  -- Reemplaza 'Aprobado' por el nuevo estado deseado
	fecha_estado = NOW()
WHERE 
    cod_prototipo = 5;   -- Reemplaza '5' por el código del prototipo que deseas modificar
```
### Código Requerimiento: CP-008<br>
#### Código Interfaz: ICP-015<br>
![image](https://github.com/user-attachments/assets/d75e0655-82fa-48b3-bfb6-9220191cce35)
#### Código Interfaz: ICP-016<br>
![image](https://github.com/user-attachments/assets/4b661f43-8fa9-4208-8327-db4f26d5ed71)
#### Código Interfaz: ICP-017<br>
![image](https://github.com/user-attachments/assets/80e83fd0-caeb-4e58-ada1-a89d1e15d76b)
#### Código Interfaz: ICP-018<br>
![image](https://github.com/user-attachments/assets/d779722a-19ad-4fe2-8241-abdbffc43c3a)

### Sentencias SQL
#### Eventos
#### Boton Administrar Publicidad
En la interfaz ICP-001 se encuentra el boton Administrar publicidad que manda al usuario ejecutivo al ICP-015
#### Boton Administrar Solicitudes
En la interfaz ICP-015 Se encuentra el boton administrar solicitudes el cual amnda al usuario ejecutivo a la interfaz ICP-016 donde puede ver el listado de las propuestas con estado pendiente
#### Boton Ver Archivos
En la interfaz ICP-016 se encuentra el boton Ver Archivos donde se manda al usuario a la interfaz ICP-017 donde el administrador podra ver los archivos 
#### Boton Ver Analisis
En la interfaz ICP-017 el usuaario sera mandado a la interfaz ICP-018 dinde  podra ver el archivo de analisis de mercado del prototipo
#### Boton Administrar solicitudes
Este boton de la interfaz ICP-018 mandara al administrador a la interfaz ICP-016
#### Boton Check
Este boton de la interfaz ICP-016 cambiara el estado del prototipo asociado a aprobado
#### Boton Check
Este boton de la interfaz ICP-016 cambiara el estado del prototipo asociado a rechazado
```sql
-- Listado de prototipos pendientes
SELECT 
    p.cod_prototipo,                  -- Código del prototipo
    p.nombre_prot AS Nombre,           -- Nombre del prototipo   
    p.Prop_presupuesto AS Presupuesto, -- Presupuesto del prototipo
    p.Fecha_creacion AS Fecha_creacion,-- Fecha de creación del prototipo
    p.Fecha_estado AS Fecha_estado,    -- Fecha de cambio de estado
    e.Nombre || ' ' || e.Apellido AS Autor -- Autor del prototipo
FROM 
    Prototipo p
JOIN 
    Estado_prototipo ep ON p.cod_est_prot = ep.cod_est_prot
JOIN 
    Empleado e ON p.ID_empleado = e.ID_empleado
WHERE 
    ep.estado_prot = 'Aprobado'
ORDER BY 
    p.Fecha_creacion;
```
```sql
--Recursos de un prototipo
SELECT 
    p.cod_prototipo,                      -- Código del prototipo
    p.nombre_prot,                        -- Nombre del prototipo
    r.nombre_recurso,                     -- Nombre del recurso
    r.url_recurso,                        -- URL del recurso
    tr.nombre_tipo AS Tipo_recurso        -- Tipo del recurso (ej. Foto, Video, etc.)
FROM 
    Prototipo p
JOIN 
    recursos r ON p.cod_prototipo = r.cod_prototipo

JOIN 
    Tipo_recurso tr ON r.id_tipo_recurso = tr.id_tipo_recurso
WHERE 
    p.cod_prototipo = 5                 
ORDER BY 
    r.nombre_recurso;
```
```sql
--Aprobacion o rechazo del prototipo
UPDATE Prototipo
SET 
    cod_est_prot = (SELECT cod_est_prot 
                    FROM Estado_prototipo 
                    WHERE estado_prot = 'Aprobado')  -- Para este caso se dio al boton check 
WHERE 
    cod_prototipo = 5;   -- prototipo asociado
```

### Código Requerimiento: CP-009<br>
#### Código Interfaz: ICP-019<br>
![image](https://github.com/user-attachments/assets/3ef56bea-7493-4edd-9e4b-7efaaf06e643)

#### Código Interfaz: ICP-020<br>
![image](https://github.com/user-attachments/assets/30f962ba-3ada-42f2-a367-f909d6d000e4)


#### Código Interfaz: ICP.021<br>
![image](https://github.com/user-attachments/assets/2e7e6e6b-c81c-4142-ad51-a96b2887948d)

### Sentencias SQL
#### Eventos
En la interfaz ICP-019 se muestran todos los prototipos aprobados ademas de dos botones
#### Boton Ver Mas 
En la interfaz ICP-019 esta el boton ver mas que manda al administrador a la interfaz ICP-020 y muestra los detalles del prototipo aprobado 
#### Boton Editar Archivos
En la interfaz ICP-020 se puede ver el boton Editar Archivo el cual nos mandara al ICP-008 donde el administrador subira los archivos finales
#### Boton Regresar
En la interfaz ICP-020 se encuentra el boton regresar que nos mandara a la interfaz ICP-019
#### Boton Lanzar
Este boton permitira al administrador mandar el prototipo a la base de datos de campañas publicitarias es decir se crearia una campaña publicitaria

```sql
--Listado de prototipos aprobados    
SELECT 
    p.cod_prototipo,                      -- Código del prototipo
    p.nombre_prot AS Nombre_prototipo,     -- Nombre del prototipo
    e.Nombre || ' ' || e.Apellido AS Autor, -- Nombre completo del empleado
    ep.estado_prot AS Estado,              -- Estado del prototipo
    p.Prop_presupuesto AS Presupuesto,     -- Presupuesto del prototipo
    p.Fecha_creacion,                      -- Fecha de creación del prototipo
    p.Fecha_estado                         -- Fecha de último cambio de estado
FROM 
    Prototipo p
JOIN 
    Empleado e ON p.ID_empleado = e.ID_empleado
JOIN 
    Estado_prototipo ep ON p.cod_est_prot = ep.cod_est_prot
WHERE 
    ep.estado_prot = 'Aprobado'            -- Filtra solo los prototipos con estado 'Aprobado'
ORDER BY 
    p.Fecha_creacion DESC;
```
```sql
--edicion de archivos para la parte final   
UPDATE Recursos
SET url_recurso = CASE 
    WHEN id_tipo_recurso = (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Foto') THEN 'http://example.com/foto'
    WHEN id_tipo_recurso = (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Video') THEN 'http://example.com/video'
    WHEN id_tipo_recurso = (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Guion') THEN 'http://example.com/guion'
    WHEN id_tipo_recurso = (SELECT id_tipo_recurso FROM Tipo_recurso WHERE nombre_tipo = 'Documento') THEN 'http://example.com/documento'
    ELSE url_recurso -- Mantiene el valor actual si no es ninguno de los tipos mencionados
END
WHERE cod_prototipo = 5;
```
```sql
-- Mandado del prototipo a campaña publicitaria
INSERT INTO Campana_Publicitaria (Resultado, Presupuesto, Nombre_campana, Audiencia, fecha_publicacion, fecha_finalizacion, cod_promocion, cod_prototipo)
SELECT 
    'Resultado Predefinido' AS Resultado,         -- Valor genérico para el resultado
    p.Prop_presupuesto AS Presupuesto,             -- Presupuesto del prototipo
    p.nombre_prot AS Nombre_campana,              -- Nombre del prototipo como nombre de la campaña
    p.Prop_audiencia AS Audiencia,                  -- Audiencia del prototipo
    NOW() AS fecha_publicacion,                    -- Fecha actual
    NOW() + INTERVAL '30 days' AS fecha_finalizacion, -- Fecha finalización (30 días después)
    1 AS cod_promocion,                            -- ID de la promoción (ajusta según tus datos)
    p.cod_prototipo                                 -- ID del prototipo
FROM 
    Prototipo p
WHERE 
    p.cod_prototipo = 5; 
```


## Módulo de Gestión Integral de Reclutamiento y Selección
### 1. Código requerimiento: M-001
Interfaces:
1. Código: MI-001
![image](https://github.com/user-attachments/assets/28fbbd31-0548-445f-93b3-3cfbb55b16ee)
2. Código: MI-002
![image](https://github.com/user-attachments/assets/19f0511c-5941-45ec-ab94-5baa761580a6)
3. Código: MI-003
![image](https://github.com/user-attachments/assets/35924d98-df9b-4793-a54b-4efc87f5d188)

```sql
Sentencias:
1. Todas las vacantes:
SELECT v.*, p.nombre AS nombre_puesto
FROM Vacante v
JOIN Puesto p ON v.id_puesto = p.id_puesto;
2. Filtro de vacantes:
SELECT v.*, p.nombre AS nombre_puesto
FROM Vacante v
JOIN Puesto p ON v.id_puesto = p.id_puesto
WHERE v.estado = 'Abierta';
3. Edición de una vacante
UPDATE Vacante
SET nombre = 'Nuevo Nombre', descripcion = 'Nueva Descripción', salario = 50000
WHERE id_vacante = 1;
```

### 2. Código requerimiento: M-002
Interfaces:
1. Código: MI-004
![image](https://github.com/user-attachments/assets/f7aa3253-f9fc-4fca-9118-c5f4fc294271)

```sql
Sentencias:
1. INSERT INTO Vacante (id_puesto, descripcion, fecha_publicacion, estado)
VALUES (1, 'Descripción de la vacante', '2024-01-01', 'Abierta');
```

### 3. Código requerimiento: M-003
Interfaces:
1. Código: MI-005
![image](https://github.com/user-attachments/assets/879c6b56-34ea-4ef2-b5fa-07a2a90fcd8c)

```sql
Sentencias:
1. Eliminar una vacante y tablas que poseen su id
-- Eliminar convocatorias relacionadas con la vacante
DELETE FROM Convocatoria
WHERE id_vacante = 1;

-- Eliminar postulantes relacionados con la vacante
DELETE FROM Postulante
WHERE id_vacante = 1;

-- Eliminar ofertas laborales relacionadas con la vacante
DELETE FROM Oferta_Laboral
WHERE id_vacante = 1;

-- Eliminar la vacante
DELETE FROM Vacante
WHERE id_vacante = 1;
```

### 4. Código requerimiento: M-004
Interfaces:
1. Código: MI-006
![image](https://github.com/user-attachments/assets/858a6a73-fb1a-48ef-be6b-1bd7935ca732)
2. Código: MI-007
![image](https://github.com/user-attachments/assets/8fb969a4-e18a-4906-92e7-ef75f1430e07)

```sql
Sentencias:
1. Eliminar un postulante y sus tablas asociadas por id
-- Eliminar registros de Observacion relacionados con las entrevistas del postulante
DELETE FROM Observacion
WHERE id_entrevista IN (SELECT id_entrevista FROM Entrevista WHERE id_postulante = <id_postulante>);

-- Eliminar registros de Entrevista relacionados con el postulante
DELETE FROM Entrevista
WHERE id_postulante = <id_postulante>;

-- Eliminar registros de Oferta_Laboral_Beneficio relacionados con el postulante
DELETE FROM Oferta_Laboral_Beneficio
WHERE id_oferta IN (SELECT id_oferta FROM Oferta_Laboral WHERE id_postulante = <id_postulante>);

-- Eliminar registros de Oferta_Laboral relacionados con el postulante
DELETE FROM Oferta_Laboral
WHERE id_postulante = <id_postulante>;

-- Eliminar registros de Habilidad_Postulante relacionados con el postulante
DELETE FROM Habilidad_Postulante
WHERE id_postulante = <id_postulante>;

-- Eliminar registros de Idioma_Postulante relacionados con el postulante
DELETE FROM Idioma_Postulante
WHERE id_postulante = <id_postulante>;

-- Eliminar registros de Habilidad_Experiencia relacionados con las experiencias laborales del postulante
DELETE FROM Habilidad_Experiencia
WHERE id_experiencia IN (SELECT id_experiencia FROM Experiencia_Laboral WHERE id_postulante = <id_postulante>);

-- Eliminar registros de Experiencia_Laboral relacionados con el postulante
DELETE FROM Experiencia_Laboral
WHERE id_postulante = <id_postulante>;

-- Eliminar registros de Educacion relacionados con el postulante
DELETE FROM Educacion
WHERE id_postulante = <id_postulante>;

-- Eliminar el postulante
DELETE FROM Postulante
WHERE id_postulante = <id_postulante>;
```

### 5. Código requerimiento: M-005
Interfaces:
1. Código: MI-008
![image](https://github.com/user-attachments/assets/8bf3ad69-2fc5-4388-926d-ba878d3f428e)

```sql
Sentencias:
1. Crear un postulante y todas las entidades conectadas a él por su id
-- Insert into Postulante
INSERT INTO Postulante (id_postulante, nombre, apellido, email, telefono, direccion, fecha_nacimiento, genero, estado_civil, nacionalidad)
VALUES (101, 'John', 'Doe', 'john.doe@example.com', '1234567890', '123 Main St', '1990-01-01', 'M', 'Soltero', 'USA');

-- Insert into Idioma_Postulante
INSERT INTO Idioma_Postulante (id_postulante, id_idioma, nivel)
VALUES (101, 1, 'Intermedio'), (101, 2, 'Avanzado');

-- Insert into Habilidad_Postulante
INSERT INTO Habilidad_Postulante (id_postulante, nombre, nivel)
VALUES (101, 'Java Programming', 'Avanzado'), (101, 'SQL', 'Intermedio');

-- Insert into Oferta_Laboral
INSERT INTO Oferta_Laboral (id_postulante, id_vacante, fecha_oferta, fecha_inicio_propuesta, link_documento_legal_sin_firma, link_documento_legal_con_firma, estado)
VALUES (101, 1, '2024-01-01', '2024-02-01', 'link101_sin_firma', 'link101_con_firma', 'Pendiente');

-- Insert into Entrevista
INSERT INTO Entrevista (estado, fecha, puntaje_general, id_postulante, ID_empleado, tipo_entrevista)
VALUES ('Pendiente', '2024-01-15', 85, 101, 1, 'Inicial');

-- Insert into Observacion
INSERT INTO Observacion (id_entrevista, nombre, descripcion)
VALUES (1, 'Observation 101', 'The candidate showed strong analytical skills.');
```

### 6. Código requerimiento: M-006
Interfaces:
1. Código: MI-009
![image](https://github.com/user-attachments/assets/de4fa0ce-2aad-4025-814b-bf183fd620cb)

```sql
Sentencias:
1. Actualizar información de un postulante y todas las tablas asociadas a él
-- Actualizar información del postulante
UPDATE Postulante
SET nombre = 'Nuevo Nombre', apellido = 'Nuevo Apellido', email = 'nuevoemail@example.com'
WHERE id_postulante = 1;

-- Actualizar habilidades del postulante
UPDATE Habilidad_Postulante
SET nivel = 'Avanzado'
WHERE id_postulante = 1 AND nombre = 'Project Management';

-- Actualizar idiomas del postulante
UPDATE Idioma_Postulante
SET nivel = 'Avanzado'
WHERE id_postulante = 1 AND id_idioma = 1;

-- Actualizar ofertas laborales del postulante
UPDATE Oferta_Laboral
SET estado = 'Aceptada'
WHERE id_postulante = 1 AND id_vacante = 1;

-- Actualizar entrevistas del postulante
UPDATE Entrevista
SET estado = 'Hecha', puntaje_general = 95
WHERE id_postulante = 1 AND ID_empleado = 1;
```

### 7. Código requerimiento: M-007
Interfaces:
1. Código: MI-010
![image](https://github.com/user-attachments/assets/e018889a-8a09-4603-bdd2-ab2d7b32972c)

```sql
Sentencias:
1. Obtener todos los datos asociados al postulante directamente
SELECT p.*, 
       e.*, 
       he.*, 
       i.*, 
       ip.*, 
       hp.*, 
       ol.*, 
       olb.*, 
       ent.*, 
       obs.*
FROM Postulante p
LEFT JOIN Experiencia e ON p.id_postulante = e.id_postulante
LEFT JOIN Habilidad_Experiencia he ON e.id_experiencia = he.id_experiencia
LEFT JOIN Idioma_Postulante ip ON p.id_postulante = ip.id_postulante
LEFT JOIN Idioma i ON ip.id_idioma = i.id_idioma
LEFT JOIN Habilidad_Postulante hp ON p.id_postulante = hp.id_postulante
LEFT JOIN Oferta_Laboral ol ON p.id_postulante = ol.id_postulante
LEFT JOIN Oferta_Laboral_Beneficio olb ON ol.id_oferta = olb.id_oferta
LEFT JOIN Entrevista ent ON p.id_postulante = ent.id_postulante
LEFT JOIN Observacion obs ON ent.id_entrevista = obs.id_entrevista
WHERE p.id_postulante = [ID_POSTULANTE];
2. Formación de feedback
SELECT e.*, o.nombre AS nombre_observacion, o.descripcion AS descripcion_observacion
FROM Entrevista e
LEFT JOIN Observacion o ON e.id_entrevista = o.id_entrevista
WHERE e.id_postulante = [ID_POSTULANTE];
```
### 8. Código requerimiento: M-008
Interfaces:
1. Código: MI-011
![image](https://github.com/user-attachments/assets/d7db406b-0804-4772-ad41-799574624ca4)
2. Código: MI-012
![image](https://github.com/user-attachments/assets/ec3c3be1-d410-430a-860d-eabc5fbcc841)

```sql 
Sentencias:
1. Creación de una entrevista de un postulante
INSERT INTO Entrevista (estado, fecha, puntaje_general, id_postulante, ID_empleado, tipo_entrevista)
VALUES ('Pendiente', '2024-05-01', 0, 101, 1, 'Inicial');
```

### 9.  Código requerimiento: M-009
Interfaces:
1. Código: MI-013
![image](https://github.com/user-attachments/assets/0a2cde1c-5b9f-44da-aedb-c281038111a1)
2. Código: MI-014
![image](https://github.com/user-attachments/assets/6c9ea689-4009-45eb-9a2e-6cf64355fe33)

```sql
Sentencias:
1.Editar una entrevista de un postulante
UPDATE Entrevista
SET estado = 'Hecha',
    fecha = '2024-01-16',
    puntaje_general = 90,
    id_postulante = 2,
    ID_empleado = 2,
    tipo_entrevista = 'HR'
WHERE id_entrevista = 1;
```

### 10. Código requerimiento: M-010
Interfaces:
1. Código: MI-015
![image](https://github.com/user-attachments/assets/892ce9b5-5a6f-4526-8f46-a70723bb5356)

```sql
Sentencias:
1. Eliminar entrevista y los asociados a ella por id
-- Eliminar observaciones asociadas a la entrevista
DELETE FROM Observacion
WHERE id_entrevista = <id_entrevista>;

-- Eliminar la entrevista
DELETE FROM Entrevista
WHERE id_entrevista = <id_entrevista>;

```
### 11. Código requerimiento: M-011
Interfaces:
1. Código: MI-016
![image](https://github.com/user-attachments/assets/d3c530e8-3de1-4ec3-9f88-0041e8666cf6)

```sql
Sentencias:
1. Crear observación a una entrevsita
INSERT INTO Observacion (id_entrevista, nombre, descripcion) 
VALUES (101, 'Observation 101', 'The candidate demonstrated excellent communication skills.');
```

### 12. Código requerimiento: M-012
Interfaces:
1. Código: MI-017
![image](https://github.com/user-attachments/assets/c86c6f3c-ede5-4fda-8797-91f2a243336e)

```sql
Sentencias:
1. Editar una observación
UPDATE Observacion
SET nombre = 'Nuevo nombre', descripcion = 'Nueva descripción'
WHERE id_entrevista = 1;
```

### 13. Código requerimiento: M-013
Interfaces:
1. Código: MI-018
![image](https://github.com/user-attachments/assets/7e5ad77d-5b53-4a6c-afd0-9a2bfc04d433)

```sql
Sentencias:
1. Eliminar una observación
DELETE FROM Observacion
WHERE id_entrevista = 1 AND nombre = 'Observation 1';
```

### 14. Código requerimiento: M-014
Interfaces:
1. Código: MI-019
![image](https://github.com/user-attachments/assets/51ac886a-68b7-459c-a7cc-4ce25461e567)

```sql
Sentencias:
1. Actualizar una oferta laboral
-- Actualizar la oferta laboral
UPDATE Oferta_Laboral
SET fecha_oferta = '2023-12-01',
    fecha_inicio_propuesta = '2024-01-01',
    link_documento_legal_sin_firma = 'nuevo_link_sin_firma',
    link_documento_legal_con_firma = 'nuevo_link_con_firma',
    estado = 'Aceptada'
WHERE id_oferta = 1;

-- Eliminar los beneficios actuales asociados a la oferta laboral
DELETE FROM Oferta_Laboral_Beneficio
WHERE id_oferta = 1;

-- Insertar los nuevos beneficios asociados a la oferta laboral
INSERT INTO Oferta_Laboral_Beneficio (id_oferta, id_beneficio) VALUES
(1, 1),
(1, 2),
(1, 3);
```

### 15. Código requerimiento: M-015
Interfaces:
1. Código: MI-020
![image](https://github.com/user-attachments/assets/4d166085-7eec-40cf-876c-975b1f41e06b)

```sql
Sentencias:
1. Crear nuevo empleado
INSERT INTO Empleado (id_postulante, nombre, apellido, fecha_contratacion, puesto)
SELECT id_postulante, nombre, apellido, CURDATE(), 'Puesto Asignado'
FROM Postulante
WHERE id_postulante = 1;
```

### 16. Código requerimiento: M-016
Interfaces:
1. Código: MI-021
![image](https://github.com/user-attachments/assets/ede0218f-69ba-499c-8794-614c9393b6de)
2. Código: MI-022
![image](https://github.com/user-attachments/assets/74b069dd-36dc-4bbc-aebb-7d86778b5560)

```sql
Sentencias:
1. Organigrama:
SELECT d1.nombre AS departamento, d2.nombre AS departamento_superior
FROM Departamento d1
LEFT JOIN Departamento d2 ON d1.id_departamento_superior = d2.id_departamento;  
2. Puestos por departamento:
SELECT d.nombre AS nombre_departamento, p.nombre AS nombre_puesto
FROM Puesto p
JOIN Departamento d ON p.id_departamento = d.id_departamento
ORDER BY d.nombre, p.nombre;
3. Crear puesto y funciones asociadas por id:
-- Crear el puesto
INSERT INTO Puesto (nombre, descripcion) VALUES ('Nuevo Puesto', 'Descripción del nuevo puesto');

-- Obtener el id del puesto recién creado
SET @id_puesto = LAST_INSERT_ID();

-- Crear las funciones asociadas al puesto
INSERT INTO Funcion (id_puesto, descripcion) VALUES
(@id_puesto, 'Función 1 del nuevo puesto'),
(@id_puesto, 'Función 2 del nuevo puesto'),
(@id_puesto, 'Función 3 del nuevo puesto');
```

### 17. Código requerimiento: M-017
Interfaces:
1. Código: MI-023
![image](https://github.com/user-attachments/assets/e563139c-e813-4cb7-a70f-c78bbeaf4c8b)

```sql
Sentencias:
1. Editar un puesto y sus funciones asociadas
-- Actualizar el puesto
UPDATE Puesto
SET nombre = 'Nuevo Nombre del Puesto', descripcion = 'Nueva Descripción del Puesto'
WHERE id_puesto = 1;

-- Eliminar las funciones asociadas al puesto
DELETE FROM Funcion
WHERE id_puesto = 1;

-- Insertar las nuevas funciones asociadas al puesto
INSERT INTO Funcion (id_puesto, descripcion)
VALUES
(1, 'Nueva Función 1'),
(1, 'Nueva Función 2'),
(1, 'Nueva Función 3');
```

### 18. Código requerimiento: M-018
Interfaces:
1. Código: MI-024
![image](https://github.com/user-attachments/assets/f105b3d5-e190-4867-a951-1e70e1e80e7d)

```sql
Sentencias:
1. Eliminar un puesto
-- Eliminar funciones asociadas al puesto
DELETE FROM Funciones
WHERE id_puesto = <id_puesto>;

-- Eliminar el puesto
DELETE FROM Puesto
WHERE id_puesto = <id_puesto>;
```

### 19. Código requerimiento: M-019
Interfaces:
1. Código: MI-025
![image](https://github.com/user-attachments/assets/0ba4067f-d0b4-4efb-9343-4663daf353c0)

```sql
Sentencias:
1. Eliminar una convocatoria
DELETE FROM Vacante
WHERE id_vacante = <id_de_la_convocatoria>;
```

### 20. Código requerimiento: M-020
Interfaces:
1. Código: MI-026
![image](https://github.com/user-attachments/assets/520b7b9d-bd79-4740-a451-104d5e9d6227)

```sql
Sentencias:
1. Crear una nueva convocatoria
INSERT INTO Convocatoria (id_convocatoria, nombre, descripcion, fecha_inicio, fecha_fin, estado)
VALUES (1, 'Convocatoria de Desarrolladores', 'Buscamos desarrolladores con experiencia en Java y SQL', '2024-01-01', '2024-01-31', 'Abierta');
```

### 21. Código requerimiento: M-021
Interfaces:
1. ![image](https://github.com/user-attachments/assets/28d5d861-5626-4fcb-be3b-0e94c2bf17b7)

```sql
Sentencias:
1. Editar una convocatoria:
UPDATE Vacante
SET nombre = 'Nuevo Nombre', descripcion = 'Nueva Descripción', estado = 'Nuevo Estado'
WHERE id_vacante = 1;
```

## Módulo de Gestión de Incidentes

### Código Requerimiento: A-001
Interfaces:
1. Código: AI-001
![req1](https://github.com/user-attachments/assets/f2e15070-7901-40d9-95dc-ec9441b0ea4f)


```sql
Sentencias:
1. Asignar responsable:
UPDATE Diagnostico
SET ID_empleado = 2
WHERE cod_diag = 1;

```


### Código Requerimiento: A-002
Interfaces:
1. Código: AI-002
![req2](https://github.com/user-attachments/assets/3bed7483-9068-45a9-9344-5d3d14e4d83a)


```sql
Sentencias:
1. Modificar responsable:

UPDATE Diagnostico
SET ID_empleado = 4
WHERE cod_diag = 1;

```

### Código Requerimiento: A-003
Interfaces:
1. Código: AI-003
![req3](https://github.com/user-attachments/assets/d21d7a05-2200-48f1-9f91-8c8d0a7a9362)


```sql
Sentencias:
1. Crear diagnostico:
INSERT INTO Diagnostico (comentario, fecha_realizacion, cod_incidente, ID_empleado, cod_proveedor, cod_causa)
VALUES ('Diagnóstico detallado de prueba', '2024-11-06', 1, 1, 1, 1);


```

## Módulo de Gestión de tipificaciones de interacciones con CRM

### Código Requerimiento: J-001
Interfaces:
1. Código: JI-001
![image](https://github.com/user-attachments/assets/8ba46b7f-6d6d-4c25-8141-2bfe80a7140d)
2. Código: JI-002
![image](https://github.com/user-attachments/assets/45466dc9-0f80-4ddb-ba9a-f0b6735fb470)

```sql
Sentencias:
1. Ver historial:
SELECT c.cod_ticket ,c.id_cliente as cod_cliente,concat(ce.nombre_cli,' ',apellido_cli) as nombre_completo , c.id_conv,c.estado_conv as estado from conversacion c
inner JOIN  cliente_externo ce ON c.id_cliente = ce.id_cliente;

2. Ver conversacion por cliente:
select ce.id_cliente, concat(ce.nombre_cli,' ',ce.apellido_cli) as nombre_completo , m.remitente_cliente ,m.remitente_asesor ,m.contenido from mensaje m
INNER JOIN cliente_externo ce ON ce.id_cliente = m.remitente_cliente;
```

### Código Requerimiento: J-002
Interfaces:
1. Código: JI-003
![image](https://github.com/user-attachments/assets/45466dc9-0f80-4ddb-ba9a-f0b6735fb470)
2. Código: JI-004
![image](https://github.com/user-attachments/assets/c6484e41-bcab-4cbf-a7ff-d7f0f38d45dd)

```sql
Sentencias:
1. Creación de asignación de la conversación:
-- Previamente debe existe cod_etiqueta este seria el codigo de la etiqueta en tipificacion
select cod_etiqueta from tipificacion t;
-- Previamente debe existe id_conv este seria el codigo de la conversacion con el cliente externo
select c.id_conv from conversacion c;
-- Previamente debe existe id_estado este seria el codigo del estado.
select eta.id_estado from estado_ticket_asig eta ;
insert into ticket_asig_tip (cod_etiqueta,problema_ident,id_conv,id_estado,fecha_asig,comentario)
values (123,'Problema de envio erroneo de dinero sin avisar',5,2,CURRENT_TIMESTAMP,'Usuario comun de quejas');

2. Busqueda de codigo etiqueta:
---TRIGRAMS
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX idx_tipologia_trgm ON tipificacion USING GIN (tipologia gin_trgm_ops);
CREATE INDEX idx_categoria_trgm ON tipificacion USING GIN (categoria gin_trgm_ops);
CREATE INDEX idx_funcionalidad_trgm ON tipificacion USING GIN (funcionalidad gin_trgm_ops);
CREATE INDEX idx_descripcion_trgm ON tipificacion USING GIN (descripcion gin_trgm_ops);
SELECT 
    cod_etiqueta AS codigo,
    descripcion,
    tipologia,
    categoria,
    funcionalidad,
    similarity(descripcion, :search_query) AS descripcion_similarity,
    similarity(tipologia, :search_query) AS tipologia_similarity,
    similarity(categoria, :search_query) AS categoria_similarity,
    similarity(funcionalidad, :search_query) AS funcionalidad_similarity
FROM 
    tipificacion
WHERE 
    descripcion % :search_query  -- Filtra solo las descripciones con suficiente similitud
    OR (tipologia % :search_query AND :user_wants_tipologia = TRUE)  -- Busca por tipologia si el usuario lo desea
    OR (categoria % :search_query AND :user_wants_categoria = TRUE)  -- Busca por categoria si el usuario lo desea
    OR (funcionalidad % :search_query AND :user_wants_funcionalidad = TRUE)  -- Busca por funcionalidad si el usuario lo desea
ORDER BY 
    descripcion_similarity DESC,  -- Da prioridad a la similitud de descripcion
    GREATEST(
        similarity(tipologia, :search_query),
        similarity(categoria, :search_query),
        similarity(funcionalidad, :search_query)
    ) DESC
LIMIT 10;


### Código Requerimiento: J-003
Interfaces:
1. Código: JI-005
![image](https://github.com/user-attachments/assets/90e696c3-294c-42fd-8b4e-4eb34bbf04f9)
2. Código: JI-006
![image](https://github.com/user-attachments/assets/fa89bb21-7d2b-4e14-9264-5e54b080d690)

```sql
Sentencias:
1.Ver ticket asignados:
select a.cod_etiqueta,a.fecha_accion,tat.comentario, a.tipo_accion, et.nombre_estado 
FROM 
    historial_asignacion ha
INNER JOIN 
    ticket_asig_tip tat ON a.cod_etiqueta = tat.cod_etiqueta 
INNER JOIN 
    estado_ticket_asig et ON tat.id_estado = et.id_estado;

2. Actualizar ticket:
UPDATE ticket_asig_tip
SET 
    cod_etiqueta = :cod_etiqueta,     
    problema_ident = :problema_ident, 
    id_conv = :id_conv,                
    id_estado = :id_estado,            
    fecha_asig = CURRENT_TIMESTAMP,    
    comentario = :comentario           
WHERE 
    cod_ticket_asig = :id_ticket_asig_tip;  

```
### Código Requerimiento: J-004
Interfaces:
1. Código: JI-006
![image](https://github.com/user-attachments/assets/a9b69d9c-333e-47ab-9ff9-40e6df1b5a01)

2. Código:
```sql
Sentencias:
1. Ver notificaciones enviadas por los analistas:
SELECT 
    n.tipo_noti,
    n.mensaje,
    t.cod_etiqueta,
    n.fecha_envio,
    e.nombre AS nombre_empleado,  -- Nombre del empleado que envió la notificación
    e.apellido AS apellido_empleado -- Apellido del empleado (si es necesario)
FROM 
    notificacion n
INNER JOIN 
    ticket_asig_tip tat ON n.cod_ticket_asig = tat.cod_ticket_asig
INNER JOIN 
    tipificacion t ON tat.cod_etiqueta = t.cod_etiqueta
INNER JOIN 
    empleado e ON n.id_empleado = e.id_empleado;  -- Unir con la tabla de empleados
```
### Código Requerimiento: J-005
Interfaces:
1. Código: JI-007
![image](https://github.com/user-attachments/assets/ef35ff19-5f24-48d4-9f65-ef4360bffdfc)

2. Código: JI-008
![image](https://github.com/user-attachments/assets/e95cbca8-6994-4660-8eb3-e627e5def689)


```sql
Sentencias:
1. Ver lista tipificaciones:
select concat(t.cod_etiqueta, '-' ,t.fecha_creacion) as cambio-fecha from tipificacion t;  
   
select t.cod_etiqueta, t.fecha_creacion,t.id_asignador as responsable, t.funcionalidad,t.categoria, t.tipologia, ha.tipo_accion , t.motivo from tipificacion t 
inner join empleado e on e.id_empleado  = t.id_asignador
inner join historial_asignacion ha ON ha.tipo_accion  = t.cod_etiqueta;

2. Creación de tipificación:
select concat(t.cod_etiqueta, '-' ,t.fecha_creacion) as cambio-fecha from tipificacion t; 

insert into tipificacion (cod_etiqueta,fecha_creacion, funcionalidad,tipologia,motivo,categoria,descripcion,id_departamento,id_asignador)
values (1,CURRENT_TIMESTAMP,' Lentitud en la aplicacion', 'Asegurador','Vulnerabilidad de datos',1,2)

```
### Código Requerimiento: J-006
Interfaces:
1. Código: JI-009
![image](https://github.com/user-attachments/assets/6c25c220-90ce-45eb-a5f4-3ee242548f9e)

```sql
Sentencias:
1. Ver Historial:
select  ha.fecha_accion as fecha,t.id_asignador as responsable,t.categoria, t.funcionalidad,t.motivo, t.tipologia, t.cod_etiqueta from tipificacion t 
inner join empleado e on e.id_empleado  = t.id_asignador
inner join historial_asignacion ha ON ha.tipo_accion  = t.cod_etiqueta;
```
### Código Requerimiento: J-007
Interfaces:
1. Código: JI-010
![image](https://github.com/user-attachments/assets/f741cf65-a874-4b73-b23f-106f8ac285b8)

```sql
Sentencias:
1. Reporte para el business:
SELECT 
    t.cod_etiqueta, 
    COUNT(*) AS frecuencia_reasignacion
FROM 
    historial_asignacion h
JOIN 
    tipificacion t ON h.cod_etiqueta = t.cod_etiqueta
WHERE 
    h.tipo_accion IN ('sugerencia', 'edicion')
    AND EXTRACT(YEAR FROM h.fecha_accion) = 2024  -- Cambia el año según el periodo deseado
    -- Para semestre, puedes añadir: AND EXTRACT(MONTH FROM h.fecha_accion) BETWEEN 1 AND 6 (o 7 AND 12 para el segundo semestre)
GROUP BY 
    t.cod_etiqueta
ORDER BY 
    frecuencia_reasignacion DESC;

--------------------------
SELECT 
    t.cod_etiqueta, 
    AVG(EXTRACT(EPOCH FROM (c.fecha_fin - c.fecha_inicio)) / 3600) AS tiempo_promedio_resolucion_horas
FROM 
    conversacion c
JOIN 
    tipificacion t ON c.cod_ticket = t.cod_etiqueta
WHERE 
    c.estado_conv = 'resuelto'  -- Asegúrate de que 'resuelto' es el estado final de los tickets
    AND EXTRACT(YEAR FROM c.fecha_inicio) = 2024
GROUP BY 
    t.cod_etiqueta
ORDER BY 
    tiempo_promedio_resolucion_horas;

-------------------------   
SELECT 
    EXTRACT(YEAR FROM t.fecha_creacion) AS año,
    COUNT(*) AS cantidad_tipificaciones
FROM 
    tipificacion t
WHERE 
    EXTRACT(YEAR FROM t.fecha_creacion) = 2024  -- Cambia el año según el periodo deseado
GROUP BY 
    EXTRACT(YEAR FROM t.fecha_creacion)
ORDER BY 
    año;
---------------------
   SELECT 
    h.realizado_por AS id_analista, 
    COUNT(*) AS frecuencia_modificaciones
FROM 
    historial_asignacion h
WHERE 
    h.tipo_accion = 'modificacion'
    AND EXTRACT(YEAR FROM h.fecha_accion) = 2024  -- Cambia el año según el periodo deseado
GROUP BY 
    h.realizado_por
ORDER BY 
    frecuencia_modificaciones DESC;
```
### Código Requerimiento: J-008
Interfaces:
1. Código: JI-011
![image](https://github.com/user-attachments/assets/674a95d3-8c29-4a31-929a-7422731cc43b)
2. Código: JI-012
![image](https://github.com/user-attachments/assets/5255ad73-c42f-4c36-8e86-e875b9ea6f89)
3. Código: JI-013

```sql
Sentencias:
1. Monitoreo de vista del anaiista:
select ha.cod_etiqueta from historial_asignacion ha
order by ha.fecha_accion desc
limit 1;

select ha.cod_etiqueta, ha.fecha_accion as fecha, ha.realizado_por as responsable, tat.comentario , ha.tipo_accion, eta.nombre_estado from historial_asignacion ha 
inner join ticket_asig_tip tat on tat.cod_etiqueta = ha.cod_etiqueta 
inner join estado_ticket_asig eta on eta.id_estado  = tat.id_estado;

2. Sugerencias
insert into notificacion(n.cod_ticket_asig as etiqueta, n.cod_etiqueta as "etiqueta sugerida", n.tipo_noti as tipo, n.mensaje)
values (12,13,"sugerencia", "Corregir de manera inmediata")

3. Edición de etiqueta por el error del asesor:
UPDATE Ticket_asig_tip
SET 
    cod_etiqueta = :nuevo_cod_etiqueta,    -- Nuevo código de etiqueta
    bloqueado = TRUE,                       -- Se bloquea la tipificación para que no pueda ser editada
    fecha_asig = CURRENT_TIMESTAMP          -- Actualiza la fecha de asignación a la actual
WHERE 
    cod_ticket_asig = :id_ticket_asig_tip   -- Identifica el ticket que se quiere actualizar
    AND bloqueado = FALSE;                  -- Asegura que solo se pueda actualizar si no está bloqueado previamente
```
### Código Requerimiento: J-009
Interfaces:
1. Código: JI-014
![image](https://github.com/user-attachments/assets/28419863-e2a0-40c2-9c5c-a7e0b72f490a)

```sql
Sentencias:
1. Reporte para el analista :
SELECT 
    t.categoria, 
    t.tipologia, 
    t.funcionalidad, 
    t.motivo,
    COUNT(*) AS volumen_contacto
FROM 
    tipificacion t
JOIN 
    conversacion c ON c.cod_ticket = t.cod_etiqueta
WHERE 
    EXTRACT(YEAR FROM c.fecha_inicio) = 2024  -- Cambia el año según el periodo deseado
GROUP BY 
    t.categoria, t.tipologia, t.funcionalidad, t.motivo
ORDER BY 
    volumen_contacto DESC;

------------ 
SELECT 
    h.realizado_por AS id_analista, 
    SUM(CASE WHEN h.tipo_accion = 'sugerencia' THEN 1 ELSE 0 END) AS cantidad_sugerencias,
    SUM(CASE WHEN h.tipo_accion = 'correccion' THEN 1 ELSE 0 END) AS cantidad_correcciones
FROM 
    historial_asignacion h
WHERE 
    h.tipo_accion IN ('sugerencia', 'correccion')
    AND EXTRACT(YEAR FROM h.fecha_accion) = 2024  -- Cambia el año según el periodo deseado
GROUP BY 
    h.realizado_por
ORDER BY 
    id_analista;
---------------------------------
SELECT 
    h.realizado_por AS id_analista,
    COUNT(*) AS total_sugerencias,
    SUM(CASE WHEN n.tipo_noti = 'sugerencia' THEN 1 ELSE 0 END) AS sugerencias_adoptadas,
    (SUM(CASE WHEN n.tipo_noti = 'sugerencia' THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) AS tasa_adopcion
FROM 
    historial_asignacion h
LEFT JOIN 
    Notificacion n ON h.cod_ticket_asig = n.cod_ticket_asig
WHERE 
    h.tipo_accion = 'sugerencia'
    AND EXTRACT(YEAR FROM h.fecha_accion) = 2024  -- Cambia el año según el periodo deseado
GROUP BY 
    h.realizado_por
ORDER BY 
    tasa_adopcion DESC;

```

## Módulo de Gestión de Capacitaciones

#### Código Requerimiento: CAP-001<br>

Código Interfaz: CAP1-001
![image](https://github.com/user-attachments/assets/5de0a214-a2e3-4c76-bae3-1028a8b9d55e)

Código Interfaz: CAP2-001
![image](https://github.com/user-attachments/assets/3d9e3549-5488-4369-845b-f71ae663a450)

Código Interfaz: CAP3-001

![image](https://github.com/user-attachments/assets/e7cca035-b198-4134-aff2-ff71d34d515e)

Código Interfaz: CAP4-001

![image](https://github.com/user-attachments/assets/b8ba632e-4e48-464a-a649-4f5defb38dd9)

Eventos:

1. Visualizar las solicitudes pendientes
Sentencia SQL:
```sql
SELECT s.id_solicitud_cap AS "Código", 
       e.nombre || ' ' || e.apellido AS Solicitador,
       s.motivo AS Motivo,
       s.fecha_solicitud AS "Fecha Solicitud"
FROM solicitudcapacitacion s 
INNER JOIN empleado e
ON s.id_empleado = e.id_empleado
WHERE s.estado = 'pendiente' 
AND (e.nombre || ' ' || e.apellido LIKE '%' || COALESCE(NULL, '') || '%')
AND (s.fecha_solicitud = COALESCE(NULL, s.fecha_solicitud))
ORDER BY s.fecha_solicitud DESC;
```
Notar el WHERE s.estado = 'pendiente'.
Además las otras 2 restricciones son los filtros que tenemos en la primera interfaz, donde el valor NULL puede cambiar a lo ingresado en el campo.
También que está ordenado según la fecha de solicitud, descendientemente, osea que las solicitudes más recientes aparecerán primero.

2. Visualizar las solicitudes ya revisadas
Se muestra al hacer click en el botón superior derecho de la primera interfaz
Sentencia SQL:
```sql
SELECT s.id_solicitud_cap AS "Código", 
       e.nombre || ' ' || e.apellido AS Solicitador,
       s.motivo AS Motivo,
       s.fecha_solicitud AS "Fecha Solicitud",
       s.estado AS Estado
FROM solicitudcapacitacion s 
INNER JOIN empleado e
ON s.id_empleado = e.id_empleado
WHERE s.estado != 'pendiente' 
AND (e.nombre || ' ' || e.apellido LIKE '%' || COALESCE(NULL, '') || '%')
AND (s.fecha_solicitud = COALESCE(NULL, s.fecha_solicitud))
AND (s.estado = COALESCE(null , s.estado))
ORDER BY s.fecha_solicitud DESC;
```
La línea del WHERE cambia a diferente, y se agrega un filtro por estado.

3. Visualizar detalles de la solicitud
Se muestra al hacer click en el botón al lado de una solicitud.
Sentencia SQL:
```sql
SELECT s.id_solicitud_cap AS "Código", 
       e.nombre || ' ' || e.apellido AS Solicitador,
       s.motivo AS Motivo,
       s.fecha_solicitud AS "Fecha Solicitud",
       s.comentario AS Comentario,
       s.estado AS Estado,
       s.fecha_aprobacion as "Fecha Aprobación"
FROM solicitudcapacitacion s 
INNER JOIN empleado e
ON s.id_empleado = e.id_empleado
WHERE s.id_solicitud_cap = 1;
```
En este caso cambiaría según la id_solicitud_cap de la solicitud.

4. Cambiar el estado de una solicitud
En la interfaz 3 también podemos cambiar el estado de una solicitud.
Sentencia SQL:
```sql
UPDATE solicitudcapacitacion 
SET estado = 'aprobada' 
WHERE id_solicitud_cap = 1;

UPDATE solicitudcapacitacion 
SET estado = 'rechazada' 
WHERE id_solicitud_cap = 1;
```
Dependiendo del botón y el id_solicitud_cap, el código se ejecutará.

#### Código Requerimiento: CAP-002<br>
Código Interfaz: CAP1-002
![image](https://github.com/user-attachments/assets/274bab1c-0ae3-4f3a-94bb-7071f340ceb7)

Código Interfaz: CAP2-002
![image](https://github.com/user-attachments/assets/da99a8d5-9ba8-41bf-bb7c-d2e401632682)

Código Interfaz: CAP3-002
![image](https://github.com/user-attachments/assets/a37539a5-b192-41de-a6c6-45383bb56f02)

Código Interfaz: CAP4-002
![image](https://github.com/user-attachments/assets/c6b96dff-022e-48cb-b331-742c0d21c07d)

Eventos:
1. Crear una capacitación, y visualizar una lista de instructores disponibles
Aquí debemos poder visualizar todos los empleados elegibles a ser instructores en una capacitación.
Esto lo hacemos filtrando a los empleados del departamento de Recursos Humanos.
Luego procedemos con el INSERT.
Sentencia SQL:
```sql
SELECT e.id_empleado as ID,
	   e.apellido|| ' ' || e.nombre AS Nombre
FROM empleado e
INNER JOIN puesto p 
ON e.id_puesto = p.id_puesto
INNER JOIN departamento d 
ON p.id_departamento = d.id_departamento
WHERE d.id_departamento = 4;

INSERT INTO capacitacion (fecha_inicio, fecha_final, nombre, estado, descripcion, id_instructor) VALUES
('2024-10-19', '2025-02-04', 'AI Integration', 'en_proceso', 'Integer tincidunt ante vel ipsum. Praesent blandit lacinia erat. Vestibulum sed magna at nunc commodo placerat.', 12);
```
Para poder hacerlo, se tuvo que realizar 2 INNER JOIN, y por último d.id_departamento debe ser 4, que corresponde a RRHH.
Posteriormente, al ser pulsado el botón de crear, realiza un INSERT con los datos ingresados.

2. Editar una capacitación
Sentencia SQL:
```sql
UPDATE capacitacion
SET
    nombre = 'Nuevo Nombre', 
    id_instructor = '13',
    fecha_inicio = '2024-11-07',      
    fecha_final = '2024-11-15',
    descripcion = 'ASDFGHJ'
WHERE id_capacitacion = 1; 
```
Donde los campos deben cambiar según lo ingresado por el usuario.

3. Visualizar mis capacitaciones
Sentencia SQL:
```sql
SELECT c.id_capacitacion AS Cod,
	   c.nombre AS Nombre,
	   c.fecha_inicio AS "Fecha de Inicio",
	   c.fecha_final AS "Fecha Fin",
	   c.estado AS Estado
FROM capacitacion c   
WHERE c.id_instructor = 12
AND (c.nombre LIKE '%' || COALESCE(NULL, '') || '%')
AND (c.estado = COALESCE('en_proceso', c.estado));
```
Donde se utiliza el id_instructor del usuario que está actualmente en la página, y aplican filtros de nombre y estado.

#### Código Requerimiento: CAP-003<br>

Código Interfaz: CAP1-003
![image](https://github.com/user-attachments/assets/e16e3c35-48dc-4f93-baac-eb4d3ea81c1c)

Código Interfaz: CAP2-003
![image](https://github.com/user-attachments/assets/5a0c5b7c-814c-49a4-99bc-e517114abe70)

Código Interfaz: CAP3-003
![image](https://github.com/user-attachments/assets/ee7274d6-604c-4e21-996c-210382c7ca47)

Código Interfaz: CAP4-003
![image](https://github.com/user-attachments/assets/dd8819ed-05ec-4c5e-9549-a72983c8e2b2)

Eventos:
1. Carga de datos de la capacitación y contenido
Sentencia SQL:
```sql
SELECT c.id_capacitacion,
 	   c.nombre AS capacitacion_nombre,
 	   c.descripcion AS capacitacion_desc,
 	   m.id_modulo,
	   m.nombre AS modulo_nombre,
	   m.orden AS modulo_orden,
	   m.estado AS modulo_estado,
	   r.id_recurso,
       r.nombre AS recurso_nombre,
       r.contenido AS recurso_contenido,
       r.tipo AS recurso_tipo,
       r.orden AS recurso_orden,
       r.estado AS recurso_estado,
       t.id_test,
       t.nombre AS test_nombre,
       t.estado AS test_estado
FROM capacitacion c
INNER JOIN modulo m
ON m.id_capacitacion = c.id_capacitacion
INNER JOIN recurso r
ON r.id_modulo = m.id_modulo
INNER JOIN test t
ON t.id_modulo = m.id_modulo
WHERE c.id_capacitacion = 1;
```
Un select que abarca todos los datos que necesitamos para la primera interfaz.

2. Creación de un módulo
Crear un módulo a simple vista puede parecer sencillo, pero debemos ajustar el orden de todos los módulos si es que queremos agregar el módulo en un orden ya tomado.
Además necesitamos una lista desplegable de los órdenes disponibles.
Sentencia SQL:
```sql
SELECT COUNT(*) AS num_modulos
FROM modulo
WHERE id_capacitacion = 1;

UPDATE modulo
SET orden = orden + 1
WHERE id_capacitacion = 1  -- El id de la capacitación que estás modificando
AND orden >= 1;  -- El nuevo orden al que se quiere cambiar

INSERT INTO modulo (nombre, orden, estado, id_capacitacion) VALUES
('Introduction to AI', 1, 'activo', 1);
```
El código se compone de 3 partes, la primera se hace al intentar crear un módulo, para poder crear la lista desplegable, se cuentan el total de módulos que tiene la capacitación, la segunda y tercera se hacen cuando el usuario pulsa en CREAR, lo que ocasionaría, primero, un cambio de orden si es que es necesesario, para luego recién poder crear nuestro módulo.

3. Edición de un módulo
Sentencia SQL:
```sql
SELECT *,
       COUNT(*) AS num_modulos
FROM modulo
WHERE id_capacitacion = 1;

UPDATE modulo
SET orden = orden + 1
WHERE id_capacitacion = 1  -- El id de la capacitación que estás modificando
AND orden >= 1;  -- El nuevo orden al que se quiere cambiar

UPDATE modulo
SET 
    nombre = 'Introduction to AI - Updated',  
    orden = 2, 
    estado = 'inactivo'  
WHERE id_modulo = 1;
```
Para la edición, la lógica es casi la misma, solo que se necesitan los datos del módulo para ver lo que se está editando, por lo demás es idéntico.

4. Eliminación de un módulo
La eliminación de un módulo se torna un poco compleja, teniendo en cuenta que los recursos, test, resultado_test, preguntas y alternativas dependen de un módulo, eliminar uno debe comprender una eliminación en cascada de cada uno de estos.
Sentencia SQL:
```sql
DELETE FROM resultado_test WHERE id_test IN (SELECT id_test FROM test WHERE id_modulo = ?);

DELETE FROM alternativa 
WHERE id_pregunta IN (
    SELECT id_pregunta 
    FROM pregunta 
    WHERE id_test IN (
        SELECT id_test 
        FROM test 
        WHERE id_modulo = ?
    )
);

DELETE FROM pregunta 
WHERE id_test IN (
    SELECT id_test 
    FROM test 
    WHERE id_modulo = ?
);

DELETE FROM test 
WHERE id_modulo = ?;

DELETE FROM recurso
WHERE id_modulo = ?;

UPDATE modulo
SET orden = orden - 1
WHERE orden > 1;

DELETE FROM modulo 
WHERE id_modulo = ?;

```
Luego de hacer la eliminación de todo lo ligado al módulo, debemos corregir el orden, ya que al eliminar el módulo, podríamos tener un orden salteado, por lo que reducimos en 1 las ordenes de mayor valor de la que eliminaremos, y luego al fin eliminamos el módulo.

#### Código Requerimiento: CAP-004<br>

Código Interfaz: CAP1-004

![image](https://github.com/user-attachments/assets/b5423aac-e119-4183-b045-6dc1d4c02835)

Código Interfaz: CAP2-004

![image](https://github.com/user-attachments/assets/324aeab6-cbc0-4dbd-a3c9-e48c5ee7bcaf)

Código Interfaz: CAP3-004

![image](https://github.com/user-attachments/assets/6f71cbae-ad94-40a8-8d73-e9e639dd778c)

Eventos:
1. Añadir un recurso
Sentencia SQL:
```sql
SELECT COUNT(*) AS num_recursos
FROM recurso
WHERE id_modulo = 1;

UPDATE recurso
SET orden = orden + 1
WHERE id_modulo= 1  -- El id de la capacitación que estás modificando
AND orden >= 1;

INSERT INTO recurso (nombre, contenido, tipo, orden, estado, ID_modulo) values
('AI Integration Course Chronogram', 'https://www.example.com/ai-integration-course-chronogram.pdf', 'documento', 1, 'activo', 1);
```
De la misma manera que con un módulo, al agregar un recurso no solo es un INSERT, primero contar la cantidad de recursos en el módulo para poder definir que valores se puedes escoger en orden, al realizar click en añadir, debemos asegurarnos de mover en 1 unidad los ordenes superior o igual a nuestro orden, para que no se repita ningún orden.

2. Editar un recurso
Sentencia SQL:
```sql
SELECT *,
       COUNT(*) AS num_recursos
FROM recurso r 
WHERE id_recurso = 1;

UPDATE recurso
SET orden = orden + 1
WHERE id_modulo= 1  -- El id de la capacitación que estás modificando
AND orden >= 1;

UPDATE recurso
SET 
    nombre = 'AI Integration Course Chronogram', 
    contenido = 'https://www.example.com/ai-integration-course-chronogram.pdf', 
    tipo = 'documento', 
    orden = 1, 
    estado = 'activo',
    ID_modulo = 1
WHERE id_recurso = 1
```
De la misma manera a la que añadimos un recurso, lo editamos también, la diferencia es que consultamos los valores actuales del recurso, y usamos UPDATE en vez de INSERT.

3. Eliminar un recurso
Sentencia SQL:
```sql
UPDATE recurso
SET orden = orden - 1
WHERE orden > 1;

DELETE FROM recurso
WHERE id_recurso = 1;
```
Actualizamos el orden de los recursos que están en un orden superior al que eliminaremos, y luego DELETE, nada nuevo.

#### Código Requerimiento: CAP-005<br>

Código Interfaz: CAP1-005
![image](https://github.com/user-attachments/assets/bcacf872-4311-4978-815b-1414a7983181)

Código Interfaz: CAP2-005
![image](https://github.com/user-attachments/assets/c5c97733-2700-4616-851f-c92769862ed3)

Código Interfaz: CAP3-005
![image](https://github.com/user-attachments/assets/86902350-ae8e-4d27-9038-0db96c5a564a)

Código Interfaz: CAP4-005

![image](https://github.com/user-attachments/assets/b7bce53e-876e-4e35-97f8-b3cd3a2e3487)

Código Interfaz: CAP5-005

![image](https://github.com/user-attachments/assets/07bfe22f-df67-4fa0-b8b9-23036bc7f4d9)

Eventos:
1. Crear test
Sentencia SQL:
```sql
INSERT INTO test (nombre, fecha, estado, descripcion, ID_modulo) VALUES
('Introduction to AI Exam', '2024-11-02', 'cerrado', 'Introduction to AI Exam. Covering the first module and introduction to AI concepts.', 1);

INSERT INTO pregunta (titulo, tipo, ID_test) VALUES
('What is AI?', 'opcion_multiple', 1),  
('Which of the following is NOT a type of machine learning?', 'opcion_multiple', 1),  
('Which algorithm is commonly used in supervised learning?', 'opcion_multiple', 1),  
('What is the main purpose of deep learning?', 'opcion_multiple', 1),  
('Which of the following is an example of an unsupervised learning technique?', 'opcion_multiple', 1);
INSERT INTO alternativa (contenido, es_correcta, ID_pregunta) VALUES
('Artificial Intelligence is the simulation of human intelligence in machines.', 'correcto', 1),
('Artificial Intelligence is the process of copying human behavior exactly.', 'incorrecto', 1),
('Artificial Intelligence is a new form of human communication.', 'incorrecto', 1),
('Artificial Intelligence is only about programming robots.', 'incorrecto', 1),

('Supervised Learning', 'incorrecto', 2),
('Unsupervised Learning', 'incorrecto', 2),
('Reinforcement Learning', 'incorrecto', 2),
('Quantum Learning', 'correcto', 2),

('K-Nearest Neighbors (KNN)', 'correcto', 3),
('K-Means Clustering', 'incorrecto', 3),
('Apriori Algorithm', 'incorrecto', 3),
('Genetic Algorithms', 'incorrecto', 3);
```
En este casos solo es hacer los inserts proporcionados por el usuario, todo normal, el INSERT se realiza SOLO cuando se pulsa crear test.

2. Editar test
Sentencia SQL:
```sql
select * 
from test t;
 
select *
from pregunta p 
where id_test = 1;

select * 
from alternativa
WHERE id_pregunta IN (
    SELECT id_pregunta 
    FROM pregunta 
    WHERE id_test = 1);

UPDATE test
SET 
    nombre = 'Introduction to AI Exam', 
    fecha = '2024-11-02', 
    descripcion = 'Introduction to AI Exam. Covering the first module and introduction to AI concepts.', 
    ID_modulo = 1
WHERE id_test = 3;
--Updates necesarios
UPDATE pregunta
SET 
    titulo = 'What is AI?', 
    tipo = 'opcion_multiple'
WHERE id_pregunta = 2;
UPDATE alternativa
SET contenido = 'Artificial Intelligence is the simulation of human intelligence in machines and learning algorithms.',
    es_correcta = 'correcto'
WHERE ID_alternativa = 6;
--Deletes necesarios
DELETE FROM alternativa
WHERE ID_pregunta = 2;
DELETE FROM pregunta
WHERE id_pregunta = 2;

DELETE FROM alternativa
WHERE ID_alternativa = 6;
--Insert necesarios
INSERT INTO pregunta (titulo, tipo, ID_test) VALUES
('What is AI?', 'opcion_multiple', 1);
INSERT INTO alternativa (contenido, es_correcta, ID_pregunta) VALUES
('Artificial Intelligence is the simulation of human intelligence in machines.', 'correcto', 1);
```
La query se torna más larga debido a que, en nuestro menú de editar test, tenemos la opción de eliminar una pregunta, o alternativa, y añadir una pregunta o alternativa, por lo que nuestra edición se dividiría en 3 partes, UPDATE, DELETE e INSERT si es necesario.
La lógica es la siguiente, primero debemos cargar los datos iniciales, luego el usuario puede cambiarlos, o añadir o eliminar, pero SOLO se cambiará en la base de datos al utilizar editar, que es donde se leerá las acciones hechas por el usuario y se harán los UPDATE, DELETE e INSERT necesarios. Notar que hay otro DELETE cascada, que funciona si eliminamos una pregunta.
3. Eliminar test
Sentencia SQL:
```sql
DELETE FROM resultado_test WHERE id_test = 1;

DELETE FROM alternativa 
WHERE id_pregunta IN (
    SELECT id_pregunta 
    FROM pregunta 
    WHERE id_test = 1;

DELETE FROM pregunta 
WHERE id_test = 1;

DELETE FROM test 
WHERE id_test = 1;
```
Otra eliminación en cascada.

#### Código Requerimiento: CAP-006<br>

Código Interfaz: CAP1-006
![image](https://github.com/user-attachments/assets/e66e2357-dd7d-4718-8451-5b49796f1823)

Código Interfaz: CAP2-006
![image](https://github.com/user-attachments/assets/5fdeca2b-e7b8-4b14-8b67-217aa64f18c6)

Código Interfaz: CAP3-006

![image](https://github.com/user-attachments/assets/f314d048-409d-45e3-b5e9-1d74fb1780fc)

Eventos:
1. Cargar datos de un test
Sentencia SQL:
```sql
SELECT * FROM test
WHERE id_test = 1;
```
Cargamos datos del test con id 1.

2. Cargar datos de resultado_test
Sentencia SQL:
```sql
select * from resultado_test
where id_test = 1;
```
Cargamos todos los resultados correspondientes al test 1.

3. Editar el comentario de un resultado_test
Sentencia SQL:
```sql
UPDATE resultado_test
SET comentario = 'You didn''t complete the exam. Try again next time!'
where id_resultadotest = 6;
```
Cambiamos el valor de comentario si queremos.

#### Código Requerimiento: CAP-007<br>

Código Interfaz: CAP1-007
![image](https://github.com/user-attachments/assets/eb488468-951a-44bf-9c43-67d87b49e091)

Código Interfaz: CAP2-007

![image](https://github.com/user-attachments/assets/d3ada38a-19e0-465c-aa64-48d750bbb370)

Código Interfaz: CAP3-007
![image](https://github.com/user-attachments/assets/229cdcda-018c-4ec0-bd8d-2c3d41af4232)

Eventos:
1. Carga de datos de empleados en dicha capacitación
Sentencia SQL:
```sql
SELECT x.id_empleadoxcapacitacion, 
       e.id_empleado AS "Código",
       e.nombre || ' ' || e.apellido AS Empleado,
       x.resultado,
       x.estado
FROM empleadoxcapacitacion x
INNER JOIN empleado e
ON x.id_empleado = e.id_empleado
WHERE x.id_capacitacion = 1
AND (e.nombre || ' ' || e.apellido LIKE '%' || COALESCE('o', '') || '%')
AND (x.estado = COALESCE('inscrito', x.estado))
ORDER BY e.nombre || ' ' || e.apellido;
```
En este caso volvemos a usar los filtros, y ordenamos los empleados respecto a nombre y apellido.

2. Añadir empleados a la capacitación
Sentencia SQL:
```sql
SELECT e.id_empleado,
       e.nombre || ' ' || e.apellido AS Empleado
FROM empleado e
INNER JOIN empleadoxcapacitacion e2 ON e2.id_empleado = e.id_empleado 
WHERE e2.id_capacitacion != 1; 

INSERT INTO empleadoxcapacitacion (estado, resultado, id_empleado, id_capacitacion) VALUES
('inscrito', 0, 1, 1),
('inscrito', 0, 2, 1),
('inscrito', 0, 3, 1);
```
Primero cargamos la lista deplegable, donde buscamos todos los empleados que no tengan una relación con la capacitación en cuestión, en otras palabras no estén inscritas en la capacitación. Solo podemos inscribir empleados que no están en la capacitación. Luego se hace un INSERT, puede ser de 1 como de varios datos distintos.

3. Eliminar empleado de una capacitación
Sentencia SQL:
```sql
DELETE FROM empleadoxcapacitacion 
WHERE id_empleadoxcapacitacion = 2;
```
Eliminamos la relación del empleado con su capacitación.

#### Código Requerimiento: CAP-008<br>

Código Interfaz: CAP1-008
![image](https://github.com/user-attachments/assets/00a21e33-dbe0-4b77-bea1-7ea443ea8f92)

Eventos:
1. Mostrar los comentarios recibidos en la capacitación
```sql
SELECT rc.comentario
FROM retroalimen_capacitacion rc 
WHERE rc.id_capacitacion = 1
AND (rc.comentario LIKE '%' || COALESCE('help', '') || '%'); 
```
Como en las capacitaciones no entran más de 1000 personas, además que no todas las personas están obligadas a dejar su comentario, no será necesario el uso de una lista invertida, ya que los datos a buscar no son muchos.
